<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suika Game - Evolution Size Edition</title>
    <!-- „Åã„Çè„ÅÑ„ÅÑ‰∏∏ÊñáÂ≠ó„Éï„Ç©„É≥„Éà„ÇíÂ∞éÂÖ• -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #fff9f0;
            --panel-bg: #ffffff;
            --accent-pink: #ff8fa3;
            --text-main: #5d576b;
            --text-sub: #a7a2b6;
            --border-color: #ffe0e6;
            --dot-color: rgba(255, 143, 163, 0.08);
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 2px, transparent 2px);
            background-size: 30px 30px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none;
            color: var(--text-main);
            position: relative;
        }

        .bg-decoration {
            position: absolute;
            z-index: -1;
            background: white;
            filter: blur(40px);
            border-radius: 50%;
            opacity: 0.4;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, 30px); }
        }

        #main-wrapper {
            display: flex;
            align-items: center;
            gap: 40px;
            max-width: 98vw;
            z-index: 1;
        }

        #side-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-width: 320px;
        }

        .score-container {
            background: var(--panel-bg);
            padding: 15px 30px;
            border-radius: 30px;
            text-align: center;
            width: 85%;
            box-shadow: 0 8px 0 var(--border-color);
            border: 4px solid var(--border-color);
        }

        .score-label {
            font-size: 14px;
            color: var(--accent-pink);
            font-weight: 900;
            margin-bottom: -5px;
            letter-spacing: 2px;
        }

        #score {
            font-size: 64px;
            font-weight: 900;
            color: var(--text-main);
            display: block;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }

        .next-container {
            background: var(--panel-bg);
            padding: 12px 20px;
            border-radius: 25px;
            text-align: center;
            border: 4px solid var(--border-color);
            box-shadow: 0 6px 0 var(--border-color);
            width: 130px;
        }

        .next-label {
            font-size: 13px;
            color: var(--accent-pink);
            margin-bottom: 2px;
            font-weight: 900;
        }

        .next-fruit-display {
            font-size: 64px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
        }

        #evolution-visualizer {
            position: relative;
            width: 380px;
            height: 380px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
        }

        .evolution-bg-ring {
            position: absolute;
            width: 85%;
            height: 85%;
            border: 10px solid transparent;
            border-top: 10px solid rgba(255, 143, 163, 0.3);
            border-right: 10px solid rgba(255, 224, 230, 0.3);
            border-bottom: 10px solid rgba(255, 143, 163, 0.3);
            border-left: 10px solid rgba(255, 224, 230, 0.3);
            border-radius: 50%;
            animation: rotateRing 20s linear infinite;
        }

        @keyframes rotateRing {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .evo-item-node {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 4px 8px rgba(255, 143, 163, 0.2);
            z-index: 2;
            border: 2px solid;
            transition: transform 0.3s;
        }

        .evo-center-label {
            position: absolute;
            font-size: 14px;
            font-weight: 900;
            color: var(--accent-pink);
            text-align: center;
            z-index: 3;
            background: var(--panel-bg);
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
        }

        #game-container {
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            background-color: #fff;
            border-radius: 40px;
            overflow: hidden;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 2 / 3;
            height: auto;
            border: 8px solid var(--panel-bg);
            touch-action: none;
        }

        #game-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢„ÅÆ‰øÆÊ≠£: Ê®™Èï∑„É¨„Ç§„Ç¢„Ç¶„Éà */
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 40px;
            border-radius: 40px;
            text-align: center;
            display: none;
            pointer-events: auto;
            border: 8px solid var(--accent-pink);
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            width: 80%; /* ÂπÖ„ÇíÂ∫É„Åí„Çã */
            max-width: 320px;
        }

        #game-over h1 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 32px;
            color: var(--accent-pink);
        }

        .game-over-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .final-score-box {
            background: var(--bg-color);
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 5px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: var(--accent-pink);
            border: none;
            padding: 12px 30px;
            color: white;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 18px;
            font-weight: 900;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #e67e91;
            transition: all 0.1s;
            width: 100%; /* „Éú„Çø„É≥„ÇíÊ®™„ÅÑ„Å£„Å±„ÅÑ„Å´ */
        }

        button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #e67e91;
        }

        #give-up-btn {
            background: var(--text-sub);
            box-shadow: 0 5px 0 #888;
            margin-top: 10px;
            width: 80%;
            font-size: 16px;
            padding: 10px;
        }
        #give-up-btn:active {
            box-shadow: 0 2px 0 #888;
        }

        /* „É°„Éã„É•„ÉºÁîªÈù¢„Éª„É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö */
        .screen-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 2px, transparent 2px);
            background-size: 30px 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .title-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 50px;
            border: 8px solid var(--accent-pink);
            box-shadow: 
                0 0 0 10px #fff, 
                0 20px 50px rgba(255, 143, 163, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
            max-width: 420px;
        }

        .menu-title {
            font-size: 56px;
            color: var(--accent-pink);
            margin: 0 0 30px 0;
            text-shadow: 4px 4px 0px #fff, 7px 7px 0px var(--border-color);
            font-weight: 900;
            line-height: 1.1;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 300px;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 30px;
            border: 4px solid var(--border-color);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .fruit-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .fruit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            background: none;
            padding: 5px;
            border: none;
            width: 80px;
        }

        .fruit-emoji {
            font-size: 32px;
            line-height: 1;
        }

        .fruit-score {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: bold;
        }

        .arrow-next {
            display: flex;
            align-items: center;
            color: var(--accent-pink);
            font-weight: bold;
            font-size: 20px;
        }

        .high-score-display {
            font-size: 64px;
            font-weight: 900;
            color: var(--text-main);
            margin: 20px 0;
        }

        .hidden { display: none !important; }

        @media (max-width: 850px) {
            #main-wrapper { 
                flex-direction: column; 
                gap: 10px; 
                padding: 10px; 
                height: 100vh; 
                justify-content: flex-start; 
                box-sizing: border-box;
            }
            #side-panel { 
                display: grid;
                grid-template-columns: auto auto;
                grid-template-rows: auto auto auto;
                gap: 4px 15px;
                justify-content: center;
                align-items: center;
                min-width: auto;
                width: 100%;
            }
            #evolution-visualizer { 
                grid-row: 1 / 4; 
                grid-column: 1 / 2;
                width: 140px; 
                height: 140px; 
            }
            .score-container { 
                grid-row: 1 / 2; 
                grid-column: 2 / 3;
                width: auto; 
                padding: 5px 20px; 
                margin: 0;
            }
            .next-container {
                grid-row: 2 / 3;
                grid-column: 2 / 3;
                width: 100px;
                margin: 0;
            }
            #score { font-size: 32px; }
            .next-fruit-display { font-size: 40px; height: 50px; }
            #game-container {
                max-height: calc(100vh - 180px);
                width: auto;
            }
            #game-over { width: 85%; padding: 20px; }

            /* „Çπ„Éû„ÉõÁî®„Çø„Ç§„Éà„É´„Éª„É¢„Éº„ÉÄ„É´Ë™øÊï¥ */
            .title-box {
                padding: 40px 20px;
                border-width: 5px;
                box-shadow: 0 0 0 5px #fff, 0 10px 25px rgba(255, 143, 163, 0.4);
                max-width: 300px;
            }
            .menu-title {
                font-size: 42px;
                margin-bottom: 15px;
            }
            .modal-content {
                padding: 20px 5px;
                width: 95%;
            }
            .fruit-list {
                gap: 1px;
            }
            .fruit-item {
                width: 32px;
                padding: 2px;
                border-radius: 8px;
            }
            .fruit-emoji {
                font-size: 18px;
            }
            .fruit-score {
                font-size: 8px;
            }
            .arrow-next { font-size: 10px; }
            #give-up-btn {
                grid-row: 3 / 4;
                grid-column: 2 / 3;
                width: 100%;
                margin: 0;
                padding: 6px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<div class="bg-decoration" style="width: 300px; height: 300px; top: 10%; left: 5%; animation-delay: 0s;"></div>
<div class="bg-decoration" style="width: 400px; height: 400px; bottom: 10%; right: 5%; animation-delay: -2s;"></div>
<div class="bg-decoration" style="width: 200px; height: 200px; top: 40%; right: 20%; animation-delay: -5s;"></div>

<!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
<div id="title-screen" class="screen-overlay">
    <div class="title-box">
        <h1 class="menu-title">Suika Game<br><span style="font-size:24px; color:var(--text-sub); text-shadow: none;">Evolution Edition</span></h1>
        <div class="menu-buttons">
            <button id="btn-game-start">„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
            <button onclick="showHowTo()" style="background:var(--text-sub); box-shadow: 0 5px 0 #888;">„ÅÇ„Åù„Å≥„Åã„Åü</button>
            <button onclick="showScores()" style="background:#ffb3c1; box-shadow: 0 5px 0 #e59aa8;">„Éè„Ç§„Çπ„Ç≥„Ç¢</button>
        </div>
    </div>
</div>

<!-- „ÅÇ„Åù„Å≥„Åã„ÅüÁîªÈù¢ -->
<div id="how-to-screen" class="screen-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--accent-pink); margin-top:0;">„ÅÇ„Åù„Å≥„Åã„Åü</h2>
        <p>„Éï„É´„Éº„ÉÑ„ÇíËêΩ„Å®„Åó„Å¶„ÄÅÂêå„Åò„Éï„É´„Éº„ÉÑÂêåÂ£´„Çí„Åè„Å£„Å§„Åë„Çà„ÅÜÔºÅ<br>„Åè„Å£„Å§„Åè„Å®ÈÄ≤Âåñ„Åó„Å¶Â§ß„Åç„Åè„Å™„Çã„Çà„ÄÇ</p>
        <div id="fruit-list-container" class="fruit-list">
            <!-- JS„ÅßÁîüÊàê -->
        </div>
        <p>ÁÇπÁ∑ö„ÅÆ„É©„Ç§„É≥„Åã„ÇâÊ∫¢„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´Ê∞ó„Çí„Å§„Åë„Å¶„Å≠ÔºÅ</p>
        <button onclick="returnToTitle()">„ÇÇ„Å©„Çã</button>
    </div>
</div>

<!-- „Éè„Ç§„Çπ„Ç≥„Ç¢ÁîªÈù¢ -->
<div id="high-score-screen" class="screen-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--accent-pink); margin-top:0;">„Éè„Ç§„Çπ„Ç≥„Ç¢</h2>
        <div class="high-score-display" id="high-score-value">0</div>
        <button onclick="returnToTitle()">„ÇÇ„Å©„Çã</button>
    </div>
</div>

<div id="main-wrapper" class="hidden">
    <div id="side-panel">
        <div class="score-container">
            <div class="score-label">„Çπ„Ç≥„Ç¢</div>
            <span id="score">0</span>
        </div>

        <div class="next-container">
            <div class="next-label">„Å§„Åé</div>
            <div id="next-fruit" class="next-fruit-display">üçì</div>
        </div>

        <div id="evolution-visualizer">
            <div class="evolution-bg-ring"></div>
            <svg id="evolution-arrows-svg" style="position:absolute; width:100%; height:100%; pointer-events:none;">
                <defs>
                    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                        <polygon points="0 0, 8 3, 0 6" fill="#ffe0e6" />
                    </marker>
                </defs>
            </svg>
            <div class="evo-center-label">„Åó„Çì„Åã</div>
        </div>
        <button id="give-up-btn" onclick="giveUpGame()">„ÅÇ„Åç„Çâ„ÇÅ„Çã üè≥Ô∏è</button>
    </div>

    <div id="game-container">
        <div id="game-over">
            <h1>„Åä„Åó„Åæ„ÅÑÔºÅ</h1>
            <div class="game-over-content">
                <div class="final-score-box">
                    <div style="font-size: 14px; color: var(--text-sub);">„Çπ„Ç≥„Ç¢</div>
                    <div id="final-score" style="font-weight:900; font-size: 32px;">0</div>
                </div>
                <button onclick="resetGame()">„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑ</button>
                <button onclick="location.reload()" style="background:var(--text-sub); box-shadow: 0 5px 0 #888; margin-top:10px;">„Çø„Ç§„Éà„É´„Å∏</button>
            </div>
        </div>
    </div>
</div>

<!-- BGM -->
<audio id="bgm" src="https://github.com/AfterEffects-OK/SuikaGame/raw/refs/heads/main/MusMus-BGM-078%20%5B%20%E7%9F%B3%E7%95%B3%E3%81%AE%E4%B8%8B%E3%81%A7%20%5D.mp3" loop></audio>

<script>
const FRUIT_TYPES = [
    { name: '„Åï„Åè„Çâ„Çì„Åº', radius: 27, color: '#ff4d6d', score: 2, emoji: 'üçí' },
    { name: '„ÅÑ„Å°„Åî', radius: 37.5, color: '#ff758f', score: 4, emoji: 'üçì' },
    { name: '„Å∂„Å©„ÅÜ', radius: 48, color: '#c0b9dd', score: 8, emoji: 'üçá' },
    { name: '„Éá„Ç≥„Éù„É≥', radius: 60, color: '#ffb3c1', score: 16, emoji: 'üçä' },
    { name: '„Åã„Åç', radius: 75, color: '#ff85a1', score: 32, emoji: 'üçÖ' },
    { name: '„Çä„Çì„Åî', radius: 93, color: '#ff4d6d', score: 64, emoji: 'üçé' },
    { name: '„Å™„Åó', radius: 112.5, color: '#fff0f3', score: 128, emoji: 'üçê' },
    { name: '„ÇÇ„ÇÇ', radius: 132, color: '#ffccd5', score: 256, emoji: 'üçë' },
    { name: '„Éë„Ç§„Éä„ÉÉ„Éó„É´', radius: 157.5, color: '#fff0f3', score: 512, emoji: 'üçç' },
    { name: '„É°„É≠„É≥', radius: 187.5, color: '#c1d37f', score: 1024, emoji: 'üçà' },
    { name: '„Çπ„Ç§„Ç´', radius: 225, color: '#81b29a', score: 2048, emoji: 'üçâ' }
];

const WORLD_WIDTH = 600;
const WORLD_HEIGHT = 900;
const DEADLINE_Y = 150;
const DROP_COOLDOWN = 600;

const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;

let engine, render, runner;
let currentFruit = null;
let nextFruitIndex = Math.floor(Math.random() * 5);
let score = 0;
let isGameOver = false;
let canDrop = true;
let isBgmPlaying = false;
let isGameInitialized = false;
let audioCtx;
let mouseX = WORLD_WIDTH / 2;
const HIGH_SCORE_KEY = 'vibe_suika_highscore';

function init() {
    if (isGameInitialized) return;
    createVisualEvolutionPath();
    setupGamePhysics();
    setupContainerEvents();
    prepareNextFruit();
    isGameInitialized = true;
}

function startGame(enableGyro = false) {
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('main-wrapper').classList.remove('hidden');
    
    // DOM„ÅåË°®Á§∫„Åï„Çå„ÅüÂæå„Å´ÂàùÊúüÂåñ„Åó„Å™„ÅÑ„Å®„Çµ„Ç§„Ç∫Ë®àÁÆó„ÅåÁãÇ„ÅÜ„Åü„ÇÅ
    setTimeout(() => {
        if (!isGameInitialized) {
            init();
        } else {
            resetGame();
        }
        playBgm();
    }, 50);

    // „Ç∏„É£„Ç§„É≠„Çª„É≥„Çµ„ÉºÔºàÈáçÂäõÊìç‰ΩúÔºâ„ÅÆË®±ÂèØ„É™„ÇØ„Ç®„Çπ„Éà
    if (enableGyro) {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                })
                .catch(e => console.log(e));
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
    }
}

function giveUpGame() {
    if (isGameOver) return;
    
    // „Éè„Ç§„Çπ„Ç≥„Ç¢‰øùÂ≠ò
    const currentHigh = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
    if (score > currentHigh) {
        localStorage.setItem(HIGH_SCORE_KEY, score);
    }
    
    location.reload();
}

function setupGamePhysics() {
    if (runner) {
        Runner.stop(runner);
        runner = null;
    }
    if (render) {
        Render.stop(render);
        // CanvasË¶ÅÁ¥†Ëá™‰Ωì„ÅØÂâäÈô§„Åõ„Åö„ÄÅÂèÇÁÖß„Å†„ÅëÂàá„Çã
        render.canvas = null; 
        render.context = null;
        render.textures = {};
        render = null;
    }
    if (engine) {
        World.clear(engine.world);
        Engine.clear(engine);
        engine = null;
    }

    const container = document.getElementById('game-container');
    // Êó¢Â≠ò„ÅÆCanvas„Åå„ÅÇ„Çå„Å∞ÂÜçÂà©Áî®„Åô„Çã
    const existingCanvas = container.querySelector('canvas');

    engine = Engine.create({ gravity: { y: 1.5 } });
    render = Render.create({
        element: container,
        canvas: existingCanvas || undefined, // Êó¢Â≠ò„Åå„ÅÇ„Çå„Å∞‰Ωø„ÅÜ„ÄÅ„Å™„Åë„Çå„Å∞Êñ∞Ë¶è‰ΩúÊàê
        engine: engine,
        options: { width: WORLD_WIDTH, height: WORLD_HEIGHT, wireframes: false, background: '#fff' }
    });

    const wallOptions = { isStatic: true, render: { visible: false } };
    const floor = Bodies.rectangle(WORLD_WIDTH / 2, WORLD_HEIGHT + 25, WORLD_WIDTH, 50, wallOptions);
    const leftWall = Bodies.rectangle(-25, WORLD_HEIGHT / 2, 50, WORLD_HEIGHT, wallOptions);
    const rightWall = Bodies.rectangle(WORLD_WIDTH + 25, WORLD_HEIGHT / 2, 50, WORLD_HEIGHT, wallOptions);
    
    Composite.add(engine.world, [floor, leftWall, rightWall]);
    
    setupPhysicsEvents();

    Render.run(render);
    runner = Runner.create();
    Runner.run(runner, engine);
}

function resetGame() {
    // „É™„Çπ„Çø„Éº„ÉàÊôÇ„ÅÆË°®Á§∫‰∏çÂÖ∑Âêà„ÇíÂõûÈÅø„Åô„Çã„Åü„ÇÅ„ÄÅ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Çø„Ç§„Éà„É´„Å´Êàª„Çã
    location.reload();
}

function showHowTo() {
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('how-to-screen').classList.remove('hidden');
    
    const container = document.getElementById('fruit-list-container');
    if (container.children.length === 0) {
        FRUIT_TYPES.forEach((fruit, index) => {
            const item = document.createElement('div');
            item.className = 'fruit-item';
            item.innerHTML = `<div class="fruit-emoji">${fruit.emoji}</div><div class="fruit-score">${fruit.score}</div>`;
            container.appendChild(item);
            
            if (index < FRUIT_TYPES.length - 1) {
                const arrow = document.createElement('div');
                arrow.className = 'arrow-next';
                arrow.innerHTML = '‚Üí';
                container.appendChild(arrow);
            }
        });
    }
}

function showScores() {
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('high-score-screen').classList.remove('hidden');
    const highScore = localStorage.getItem(HIGH_SCORE_KEY) || 0;
    document.getElementById('high-score-value').innerText = highScore;
}

function returnToTitle() {
    document.getElementById('how-to-screen').classList.add('hidden');
    document.getElementById('high-score-screen').classList.add('hidden');
    document.getElementById('title-screen').classList.remove('hidden');
}

function createVisualEvolutionPath() {
    const container = document.getElementById('evolution-visualizer');
    const svg = document.getElementById('evolution-arrows-svg');
    const total = FRUIT_TYPES.length;
    const size = container.offsetWidth;
    const centerX = size / 2;
    const centerY = size / 2;
    const scaleFactor = size / 380; // Âü∫Êú¨„Çµ„Ç§„Ç∫„Åã„Çâ„ÅÆÁ∏ÆÂ∞èÁéá
    const orbitRadius = size * 0.38;
    const coords = [];

    FRUIT_TYPES.forEach((fruit, index) => {
        const angle = (index / total) * (Math.PI * 2) - Math.PI / 2;
        const x = centerX + orbitRadius * Math.cos(angle);
        const y = centerY + orbitRadius * Math.sin(angle);
        coords.push({x, y});

        const node = document.createElement('div');
        node.className = 'evo-item-node';
        const nodeSize = (30 + index * 5) * scaleFactor;
        node.style.width = `${nodeSize}px`;
        node.style.height = `${nodeSize}px`;
        node.style.left = `${x}px`;
        node.style.top = `${y}px`;
        node.style.transform = `translate(-50%, -50%)`;
        node.style.borderColor = fruit.color;
        node.style.fontSize = `${nodeSize * 0.7}px`;
        node.innerHTML = fruit.emoji;
        container.appendChild(node);
    });

    for (let i = 0; i < total; i++) {
        const start = coords[i];
        const end = coords[(i + 1) % total];
        if (i === total - 1) continue;
        const dx = end.x - start.x;
        const dy = end.y - start.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const nodeSizeStart = ((30 + i * 5) * scaleFactor) / 2;
        const nodeSizeEnd = ((30 + ((i + 1) % total) * 5) * scaleFactor) / 2;
        const padding = 5;
        const x1 = start.x + (dx / dist) * (nodeSizeStart + padding);
        const y1 = start.y + (dy / dist) * (nodeSizeStart + padding);
        const x2 = end.x - (dx / dist) * (nodeSizeEnd + padding);
        const y2 = end.y - (dy / dist) * (nodeSizeEnd + padding);
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1); line.setAttribute("y1", y1);
        line.setAttribute("x2", x2); line.setAttribute("y2", y2);
        line.setAttribute("stroke", "#ffe0e6"); line.setAttribute("stroke-width", "2");
        line.setAttribute("marker-end", "url(#arrowhead)");
        svg.appendChild(line);
    }
}

function prepareNextFruit() {
    if (isGameOver) return;
    const index = nextFruitIndex;
    nextFruitIndex = Math.floor(Math.random() * 5);
    document.getElementById('next-fruit').innerText = FRUIT_TYPES[nextFruitIndex].emoji;
    currentFruit = index;
    canDrop = true;
}

function spawnFruit(x, y, index) {
    const config = FRUIT_TYPES[index];
    const fruit = Bodies.circle(x, y, config.radius, {
        restitution: 0.3, friction: 0.1, label: `fruit_${index}`,
        render: { fillStyle: config.color, strokeStyle: '#fff', lineWidth: 3 }
    });
    fruit.fruitIndex = index;
    return fruit;
}

function playBgm() {
    if (isBgmPlaying) return;
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.1; // Èü≥Èáè„Çí„Åï„Çâ„Å´‰∏ã„Åí„Çã
    bgm.play().then(() => {
        isBgmPlaying = true;
    }).catch(e => console.log("Audio play failed", e));
}

function playPopSound() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.1);
}

function handleOrientation(event) {
    if (!engine) return;
    const x = event.gamma; // -90 to 90 (Â∑¶Âè≥„ÅÆÂÇæ„Åç)
    if (x === null) return;

    // ÂÇæ„Åç„ÇíÂà∂ÈôêÔºàÊúÄÂ§ß45Â∫¶„Åæ„ÅßÔºâ„Åó„Å¶ÈáçÂäõ„Å´ÂèçÊò†
    const angle = Math.min(Math.max(x, -45), 45);
    const rad = angle * (Math.PI / 180);
    engine.world.gravity.x = Math.sin(rad) * 1.5;
    engine.world.gravity.y = Math.cos(rad) * 1.5;
}

function setupContainerEvents() {
    const container = document.getElementById('game-container');
    const gameOver = document.getElementById('game-over');
    const updatePosition = (e) => {
        if (isGameOver || !canDrop) return;
        if (e.type.startsWith('touch')) e.preventDefault();
        const rect = container.getBoundingClientRect();
        const scale = WORLD_WIDTH / rect.width;
        const clientX = (e.touches && e.touches.length > 0) ? e.touches[0].clientX : e.clientX;
        mouseX = (clientX - rect.left) * scale;
        const radius = FRUIT_TYPES[currentFruit].radius;
        if (mouseX < radius) mouseX = radius;
        if (mouseX > WORLD_WIDTH - radius) mouseX = WORLD_WIDTH - radius;
    };

    // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢„Åß„ÅÆ„Çø„ÉÉ„ÉÅÊìç‰Ωú„Åå„Ç≤„Éº„É†ÂÅ¥„Å´‰ºùÊí≠„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„ÇãÔºà„Éú„Çø„É≥ÂèçÂøúÁî®Ôºâ
    const stopPropagation = (e) => e.stopPropagation();
    gameOver.addEventListener('touchstart', stopPropagation);
    gameOver.addEventListener('touchend', stopPropagation);
    gameOver.addEventListener('mousedown', stopPropagation);

    container.addEventListener('mousemove', updatePosition);
    container.addEventListener('touchstart', (e) => { playBgm(); updatePosition(e); }, {passive: false});
    container.addEventListener('touchmove', updatePosition, {passive: false});

    const handleDrop = () => {
        if (isGameOver || !canDrop) return;
        canDrop = false;
        const fruit = spawnFruit(mouseX, 120, currentFruit);
        Composite.add(engine.world, fruit);
        setTimeout(() => prepareNextFruit(), DROP_COOLDOWN);
    };

    container.addEventListener('mousedown', (e) => { playBgm(); handleDrop(); });
    container.addEventListener('touchend', (e) => { e.preventDefault(); handleDrop(); });
}

function setupPhysicsEvents() {
    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach((pair) => {
            const bodyA = pair.bodyA; const bodyB = pair.bodyB;
            if (bodyA.label.startsWith('fruit_') && bodyA.label === bodyB.label) {
                const index = bodyA.fruitIndex;
                if (index < FRUIT_TYPES.length - 1) {
                    const nextIndex = index + 1;
                    const midX = (bodyA.position.x + bodyB.position.x) / 2;
                    const midY = (bodyA.position.y + bodyB.position.y) / 2;
                    Composite.remove(engine.world, [bodyA, bodyB]);
                    const newFruit = spawnFruit(midX, midY, nextIndex);
                    Composite.add(engine.world, newFruit);
                    updateScore(FRUIT_TYPES[nextIndex].score);
                    playPopSound();
                }
            }
        });
    });

    Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        
        // ÂÆπÂô®„ÅÆÊèèÁîªÔºàËßí‰∏∏„ÅÆÊû†Á∑öÔºâ
        ctx.save();
        ctx.lineWidth = 20;
        ctx.strokeStyle = '#ffccd5'; // ÂÆπÂô®„ÅÆËâ≤ÔºàËñÑ„ÅÑ„Éî„É≥„ÇØÔºâ
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(0, -50); // Â∑¶‰∏äÔºàÁîªÈù¢Â§ñÔºâ
        ctx.lineTo(0, WORLD_HEIGHT - 20);
        ctx.quadraticCurveTo(0, WORLD_HEIGHT, 20, WORLD_HEIGHT); // Â∑¶‰∏ã„ÅÆËßí‰∏∏
        ctx.lineTo(WORLD_WIDTH - 20, WORLD_HEIGHT);
        ctx.quadraticCurveTo(WORLD_WIDTH, WORLD_HEIGHT, WORLD_WIDTH, WORLD_HEIGHT - 20); // Âè≥‰∏ã„ÅÆËßí‰∏∏
        ctx.lineTo(WORLD_WIDTH, -50); // Âè≥‰∏äÔºàÁîªÈù¢Â§ñÔºâ
        ctx.stroke();
        ctx.restore();

        ctx.beginPath(); ctx.setLineDash([5, 5]);
        ctx.moveTo(0, DEADLINE_Y); ctx.lineTo(WORLD_WIDTH, DEADLINE_Y);
        ctx.strokeStyle = '#ff8fa3'; ctx.lineWidth = 2; ctx.stroke(); ctx.setLineDash([]);

        if (canDrop && currentFruit !== null) {
            ctx.beginPath(); ctx.moveTo(mouseX, 120); ctx.lineTo(mouseX, WORLD_HEIGHT);
            ctx.strokeStyle = 'rgba(255, 143, 163, 0.1)'; ctx.stroke();
            const config = FRUIT_TYPES[currentFruit];
            ctx.beginPath(); ctx.arc(mouseX, 120, config.radius, 0, Math.PI * 2);
            ctx.fillStyle = config.color; ctx.fill();
            ctx.font = `${config.radius * 1.3}px serif`; 
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(config.emoji, mouseX, 125);
        }

        Composite.allBodies(engine.world).forEach(body => {
            if (body.fruitIndex !== undefined) {
                const config = FRUIT_TYPES[body.fruitIndex];
                ctx.save(); ctx.translate(body.position.x, body.position.y); ctx.rotate(body.angle);
                ctx.font = `${config.radius * 1.5}px serif`; 
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(config.emoji, 0, 2); ctx.restore();
            }
        });
        checkGameOver();
    });
}

function updateScore(points) {
    score += points;
    document.getElementById('score').innerText = score;
}

function checkGameOver() {
    if (isGameOver) return;
    const allBodies = Composite.allBodies(engine.world);
    let overTriggered = false;
    allBodies.forEach(body => {
        if (!body.isStatic && body.position.y < DEADLINE_Y && body.velocity.y < 0.2 && body.position.y > 0) {
            if (!body.overStartTime) body.overStartTime = Date.now();
            if (Date.now() - body.overStartTime > 2000) overTriggered = true;
        } else {
            body.overStartTime = null;
        }
    });
    if (overTriggered) {
        isGameOver = true;
        document.getElementById('game-over').style.display = 'block';
        document.getElementById('final-score').innerText = score;
        
        // „Éè„Ç§„Çπ„Ç≥„Ç¢‰øùÂ≠ò
        const currentHigh = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0');
        if (score > currentHigh) {
            localStorage.setItem(HIGH_SCORE_KEY, score);
        }
        
        Runner.stop(runner);
    }
}
// window.onload = init; // Ëá™ÂãïÈñãÂßã„Åó„Å™„ÅÑ

// „Ç≤„Éº„É†„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÅÆ„ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÂà§ÂÆö
const startBtn = document.getElementById('btn-game-start');
let clickCount = 0;
let clickTimer = null;
startBtn.addEventListener('click', (e) => {
    clickCount++;
    if (clickCount === 1) {
        clickTimer = setTimeout(() => {
            clickCount = 0;
            startGame(false); // „Ç∑„É≥„Ç∞„É´„Çø„ÉÉ„ÉóÔºöÈÄöÂ∏∏„Çπ„Çø„Éº„Éà
        }, 300);
    } else {
        clearTimeout(clickTimer);
        clickCount = 0;
        startGame(true); // „ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÔºö„Ç∏„É£„Ç§„É≠ÊúâÂäπ
    }
});
</script>
</body>
</html>